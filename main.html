<!DOCTYPE html>
<html>

<head>
  <title>Assignment1</title>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <link rel="stylesheet" type="text/css" href="http://unpkg.com/iview/dist/styles/iview.css">
  <!-- <script type="text/javascript" src="http://vuejs.org/js/vue.min.js"></script> -->
  <script src="d3.min.js"></script>
  <script type="text/javascript" src="http://unpkg.com/iview/dist/iview.min.js"></script>
</head>

<body>
  <!-- <div id="app">
    <p>{{ message }}</p>
  </div> -->
  <svg width="1600" height="800" id="mainsvg" class="svgs"></svg>
  <script>
      // new Vue({
      //   el: '#app',
      //   data: {
      //     message: 'Hello Vue.js!'
      //   }
      // })
      // The following code is the typical routine of my d3.js code. 
      const svg = d3.select('svg');
      const width = svg.attr('width');
      const height = svg.attr('height');
      const margin = {top: 60, right: 30, bottom: 60, left: 150};
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;
      const mainGroup = svg.append('g')
      .attr('transform', `translate(${margin.left}, ${margin.top})`)
      .attr('id', 'maingroup');
      // console.log(d);
      const xValue = d => d.globalsale;
      const yValue = d => d.platform;
      const xScale = d3.scaleLinear();
      const yScale = d3.scaleBand();


      const xBarValue = (datum) => {return datum.globalsale};
      const yBarValue = (datum) => {return datum.platform};
      let aduration = 1000;
      let totalduration = 20000;

      var colors = {
        'Wii':"#5E4FA2", 
        'NES':"#4E62AB", 
        'GB':"#4075B4", 
        'DS':"#3288BD",
        'X360':"#449BB5", 
        'PS3':"#55AEAD", 
        'PS2':"#66C2A5",
        'SNES':"#7DCBA4",
        'GBA':"#94D4A4", 
        '3DS':"#ABDDA4", 
        'PS4':"#BEE5A0", 
        'N64':"#D2ED9C",
        'PS':"#E6F598",
        'XB':"#FFF5AE", 
        'PC':"#FEEA9C", 
        '2600':"#FEE08B",
        'PSP':"#F0AA77", 
        'XOne':"#E27463", 
        'GC':"#D53E4F", 
        'WiiU':"#C32A4B",
        'GEN':"#B01546", 
        'DC':"#9E1346", 
        'PSV':"#8E1146", 
        'SAT':"#7E0F46",
        'SCD':"#6E0D46", 
        'WS':"#5E0B46", 
        'NG':"#4E0945", 
        'TG16':"#3E0745",
        '3DO':"#2E0545", 
        'GG':"#1E0345", 
        'PCFX':"#0E0145"
      };

      /* 
        Loading data and preprocessing data. 
        Note that you can also preprocessing data in your own way using your prefered language, e.g., Python. 
      */

      d3.csv('pgy.csv').then(data =>{
        // process data
        var sales = {};
        var platforms = [];
        for (var i = 0; i < data.length; i++){

          var year = parseInt(data[i]['year']);
          var platform = data[i]['platform'];
          var globalsale = data[i]['globalsale'];

          if (platforms.indexOf(platform) === -1){
            platforms.push(platform);
          }

          if(sales[year] !== undefined){
            sales[year][platform] = globalsale;
          }
          else{
            sales[year] = {};
            sales[year][platform] = globalsale;
          }
        }
        console.log(sales);
        console.log(platforms);

        for (var j = 0; j < platforms.length; j++){
          if(sales[1980][platforms[j]] === undefined){
            sales[1980][platforms[j]] = 0.0;
          }
        }
        for (var i = 1981; i < 2021; i++){
          for (var j = 0; j < platforms.length; j++){
            if(sales[i][platforms[j]] === undefined){
              sales[i][platforms[j]] =  sales[i-1][platforms[j]];
            }
          }
        }
        console.log(sales);

        var gamesales = {}
        for (var i = 1980; i < 2021; i++){
          var t = [];
          for (var key in sales[i]){
            t.push({
              'platform':key,
              'globalsale':sales[i][key]
            })
          }
          gamesales[i] = t;
        }
        console.log(gamesales);

        // set the animation interval; 
        aduration = totalduration / 41;
        console.log('aduration', aduration);
        let c = 1980; 
        let intervalId = setInterval(function(){
            if(c >= 2021){
                console.log('time to close this animation');
                clearInterval(intervalId); 
            }else{
              console.log(gamesales[c])

              let g = d3.select('#maingroup');

              let xScale = d3.scaleLinear()
              .domain([0, 1300])
              .range([0, innerWidth-100]);
              let yScale = d3.scaleBand()
              .domain(platforms)
              .range([0, innerHeight])
              .padding(0.01);

              const xAxisMethod = d3.axisBottom(xScale);
              const yAxisMethod = d3.axisLeft(yScale);
              const xAxisGroup = mainGroup.append('g').call(xAxisMethod);
              const yAxisGroup = mainGroup.append('g').call(yAxisMethod);
              xAxisGroup.attr('transform', `translate(${0}, ${innerHeight})`);

              const textbarchart = g.selectAll('.text-barchart').data(gamesales[c], data => data.platform);
              textbarchart.enter().append('text').attr('class', 'text-barchart')
              .attr('y', datum => yScale(yBarValue(datum)) + yScale.bandwidth() * 3 / 4)
              .attr('x', 0)
              .attr('text-anchor', 'start');
              textbarchart.text(d => d.globalsale)
              .transition().duration(aduration)
              .attr('x', (datum) => {
                  return xScale(xBarValue(datum));
              });

              g.selectAll('.rect-barchart')
              .data(gamesales[c], data => data.platform)
              .join('rect')
              .attr('class', 'rect-barchart') // note to assgin class to it, or it will create new rect each time instead of smooth animation; 
              .attr('x', 0)
              .attr('y', datum => yScale(yBarValue(datum)) + yScale.bandwidth() / 4 )
              .attr('height', yScale.bandwidth() / 2)
              .attr('fill', function(datum){return colors[datum.platform]})
              .transition().duration(aduration)
              .attr('width', (datum) => {return xScale(xBarValue(datum))}); // use xSacle to re-scale data space (domain) and return the rescaled population; 
              c = c + 1;
            }
        }, aduration); 
        
      })

      // d3.csv('platform_globalsale.csv').then(data => {

      //     // calculationg scales: 
      //     yScale.domain(data.map(yValue)).range([0, innerHeight]).padding(0.1);
      //     xScale.domain([0, d3.max(data, xValue)]).range([0, innerWidth]);   
      //     // data-join for rectangles: 

      //     console.log(mainGroup.selectAll('rect').data(data))
      //     mainGroup.selectAll('rect').data(data).join('rect')
      //     .attr('height', yScale.bandwidth()).attr('width', d => xScale(xValue(d)))
      //     .attr('x', 0).attr('y', d => yScale(yValue(d)))
      //     .attr('fill', function(d, i){
      //       return colors[d.platform];
      //     })
      //     // adding axes: 
      //     const xAxisMethod = d3.axisBottom(xScale);
      //     const yAxisMethod = d3.axisLeft(yScale);
      //     const xAxisGroup = mainGroup.append('g').call(xAxisMethod);
      //     const yAxisGroup = mainGroup.append('g').call(yAxisMethod);
      //     xAxisGroup.attr('transform', `translate(${0}, ${innerHeight})`);
      // })
  </script> 
</body>

</html>
