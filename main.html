<!DOCTYPE html>
<html>

<head>
  <title>Assignment1</title>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <link rel="stylesheet" type="text/css" href="http://unpkg.com/iview/dist/styles/iview.css">
  <script src="d3.min.js"></script>
  <script type="text/javascript" src="http://unpkg.com/iview/dist/iview.min.js"></script>
</head>

<body>

  <svg width="1600" height="800" id="mainsvg" class="svgs"></svg>
  <script>
      const svg = d3.select('svg');
      const width = svg.attr('width');
      const height = svg.attr('height');
      const margin = {top: 60, right: 30, bottom: 60, left: 150};
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;
      const mainGroup = svg.append('g')
      .attr('transform', `translate(${margin.left}, ${margin.top})`)
      .attr('id', 'maingroup');
      // console.log(d);
      const xValue = d => d.globalsale;
      const yValue = d => d.platform;

      
      let xSacle, yScale;
      const xBarValue = (datum) => {return datum.globalsale};
      const yBarValue = (datum) => {return datum.platform};
      const xAxisLabel = 'GlobalSale';
        const yAxisLabel = 'Platform';
      let aduration = 1000;
      let totalduration = 20000;

      const platforms = ["Wii", "NES", "GB", "DS", "X360", "PS3", "PS2", "SNES", "GBA", "3DS", "PS4", "N64", "PS", "XB", "PC", "2600", "PSP", "XOne", "GC", "WiiU", "GEN", "DC", "PSV", "SAT", "SCD", "WS", "NG", "TG16", "3DO", "GG", "PCFX"];

      const colors = {
        'Wii':"#5E4FA2", 
        'NES':"#4E62AB", 
        'GB':"#4075B4", 
        'DS':"#3288BD",
        'X360':"#449BB5", 
        'PS3':"#55AEAD", 
        'PS2':"#66C2A5",
        'SNES':"#7DCBA4",
        'GBA':"#94D4A4", 
        '3DS':"#ABDDA4", 
        'PS4':"#BEE5A0", 
        'N64':"#D2ED9C",
        'PS':"#E6F598",
        'XB':"#FFF5AE", 
        'PC':"#FEEA9C", 
        '2600':"#FEE08B",
        'PSP':"#F0AA77", 
        'XOne':"#E27463", 
        'GC':"#D53E4F", 
        'WiiU':"#C32A4B",
        'GEN':"#B01546", 
        'DC':"#9E1346", 
        'PSV':"#8E1146", 
        'SAT':"#7E0F46",
        'SCD':"#6E0D46", 
        'WS':"#5E0B46", 
        'NG':"#4E0945", 
        'TG16':"#3E0745",
        '3DO':"#2E0545", 
        'GG':"#1E0345", 
        'PCFX':"#0E0145"
      };

      const renderinit = function(){
        let g = d3.select('#maingroup');

        xScale = d3.scaleLinear()
        .domain([0, 1300])
        .range([0, innerWidth-100]);
        yScale = d3.scaleBand()
        .domain(platforms)
        .range([0, innerHeight-20])
        .padding(0.01);

        const xAxisMethod = d3.axisBottom(xScale);
        const yAxisMethod = d3.axisLeft(yScale);

        const xAxisGroup = mainGroup.append('g').call(xAxisMethod)
              .attr("class","x-axis")
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        xAxisGroup.append('text')
        .attr('font-size', '2em')
        .attr('y', 60)
        .attr('x', innerWidth / 2)
        .attr('fill', '#504f4f')
        .text(xAxisLabel);

        const yAxisGroup = mainGroup.append('g').call(yAxisMethod)
              .attr("class","y-axis")
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        yAxisGroup.append('text')
        .attr('font-size', '2em')
        .attr('transform', `rotate(-90)`)
        .attr('x', -(innerHeight - 20) / 2)
        .attr('y', -70)
        .attr('fill', '#504f4f')
        .text(yAxisLabel)
        .attr('text-anchor', 'middle') 
        .text(yAxisLabel);
        xAxisGroup.attr('transform', `translate(${0}, ${innerHeight-20})`);

        g.append("text")
        .attr('id', 'date_text')
        .attr("x", innerWidth - 80)
        .attr("y", innerHeight - 80)
        .attr("dy", ".5em")
        .style("text-anchor", "end")
        .attr("fill", "#504f4f")
        .attr('font-size', '6em')
        .attr('font-weight', 'bold')
        .text(' ');
      }

      /* 
        Loading data and preprocessing data. 
        Note that you can also preprocessing data in your own way using your prefered language, e.g., Python. 
      */

      d3.csv('pgy.csv').then(data =>{
        // process data
        var sales = {};
        var platforms = [];
        for (var i = 0; i < data.length; i++){

          var year = parseInt(data[i]['year']);
          var platform = data[i]['platform'];
          var globalsale = data[i]['globalsale'];

          if (platforms.indexOf(platform) === -1){
            platforms.push(platform);
          }

          if(sales[year] !== undefined){
            sales[year][platform] = globalsale;
          }
          else{
            sales[year] = {};
            sales[year][platform] = globalsale;
          }
        }
        console.log(sales);
        console.log(platforms);

        // for (var j = 0; j < platforms.length; j++){
        //   if(sales[1980][platforms[j]] === undefined){
        //     sales[1980][platforms[j]] = 0.0;
        //   }
        // }
        // for (var i = 1981; i < 2021; i++){
        //   for (var j = 0; j < platforms.length; j++){
        //     if(sales[i][platforms[j]] === undefined){
        //       sales[i][platforms[j]] = sales[i-1][platforms[j]];
        //     }
        //   }
        // }
        console.log(sales);

        var gamesales = []
        // for (var key in sales['1980']){
        //   console.log(sales['1980'], sales['1980'][key], typeof sales['1980'][key], parseFloat(sales['1980'][key]))
        //   gamesales.push({
        //     'platform':key,
        //     'globalsale':parseFloat(sales['1980'][key])
        //   })
        // }        
        // console.log('gamesales', gamesales);

        renderinit();

        // set the animation interval; 
        aduration = totalduration / 41;
        console.log('aduration', aduration);
        let c = 1980; 
        let intervalId = setInterval(function(){
            if(c >= 2021){
                console.log('time to close this animation');
                clearInterval(intervalId); 
            }else{
              console.log('year', c);

              gamesales = gamesales.sort(function(a, b){return parseFloat(b.globalsale) - parseFloat(a.globalsale)});

              var tmpgamesales = [];
              for (var i = 0; i < gamesales.length; i++){
                tmpgamesales.push({
                  'platform':gamesales[i]['platform'],
                  'globalsale':gamesales[i]['globalsale']
                });
              }
              for (var key in sales[String(c)]){
                var tmp = tmpgamesales.find(item => item.platform == key);
                if (tmp !== undefined){
                  tmp['globalsale'] = parseFloat(sales[String(c)][key]);
                }
                else{
                  tmpgamesales.push({
                    'platform':key,
                    'globalsale':parseFloat(sales[String(c)][key])
                  });
                }

                gamesales = [];
                for (var i = 0; i < tmpgamesales.length; i++){
                  gamesales.push({
                    'platform':tmpgamesales[i]['platform'],
                    'globalsale':tmpgamesales[i]['globalsale']
                  });
                }
              }

              let g = d3.select('#maingroup');

              xScale = d3.scaleLinear()
              .domain([0, d3.max(gamesales, d => d.globalsale)])
              .range([0, innerWidth-100]);

              d3.select("g.x-axis")
              .transition()
              .duration(aduration)
              .ease(d3.easeLinear)
              .call(d3.axisBottom(xScale));

              d3.selectAll("g.x-axis g.tick")
              .select("line.grid-line")
              .remove();

              let xlines = d3.selectAll("g.x-axis g.tick")
              .append("line")
              .classed("grid-line",true);
              xlines.attr("x1",0)
              .attr("y1",0)
              .attr("x2",0)
              .attr("y2",-innerHeight);


              var tmpPlatforms = [];
              for (var i = 0; i < gamesales.length; i++){
                tmpPlatforms.push(gamesales[i]['platform']);
              }

              yScale = d3.scaleBand()
              .domain(tmpPlatforms)
              .range([0, innerHeight-20])
              .padding(0.01);
              
              d3.select("g.y-axis")
              .transition()
              .duration(aduration)
              .ease(d3.easeLinear)
              .call(d3.axisLeft(yScale));

              d3.selectAll("g.y-axis g.tick")
              .select("line.grid-line")
              .remove();

              let ylines = d3.selectAll("g.y-axis g.tick")
              .append("line")
              .classed("grid-line",true);

              ylines.attr("x1",0)
              .attr("y1",0)
              .attr("x2", innerWidth)
              .attr("y2",0);


              d3.select('#date_text').text(String(c)+'年');

              const textbarchart = g.selectAll('.text-barchart').data(gamesales, data => data.platform);
              textbarchart.enter().append('text')
              .attr('class', 'text-barchart')
              .attr('y', datum => yScale(yBarValue(datum)) + yScale.bandwidth() * 7 / 10)
              .attr('x', 0)
              .attr('dx', 10)
              .attr('text-anchor', 'start')
              .attr("fill", "#504f4f")
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');

              textbarchart.text(d => d.globalsale)
              .sort(function(a, b) {
                return d3.descending(parseFloat(a.globalsale), parseFloat(b.globalsale)); 
              })
              .transition()
              .duration(aduration)
              .ease(d3.easeLinear)
              .tween('text', function(d) {
                var i = d3.interpolate(this.textContent, d.globalsale);
                return function(t){
                  var text = d3.format('.2f')(i(t));
                  if(text === '0.00'){
                    this.textContent = '';
                  }
                  else{
                    this.textContent = d3.format('.2f')(i(t));
                  }
                }
              })
              .attr('x', (datum) => {
                  return xScale(xBarValue(datum));
              })
              .attr("y", function(d, i) { //对排序之后的横坐标重排
                  return yScale(tmpPlatforms[i]) + yScale.bandwidth() * 7 / 10;
              });


              g.selectAll('.rect-barchart')
              .data(gamesales, data => data.platform)
              .join('rect')
              .attr('id', function(d){
                return d.platform;
              })
              .attr('value', function(d){
                return d.globalsale;
              })
              .attr('class', 'rect-barchart') // note to assgin class to it, or it will create new rect each time instead of smooth animation; 
              .attr('x', 0)
              .attr('y', datum => yScale(yBarValue(datum)) + yScale.bandwidth() / 10 )
              .attr('height', yScale.bandwidth() * 4 / 5)
              .attr('fill', function(datum){return colors[datum.platform]})
              .attr("rx", 5)
              .sort(function(a, b) {
                return d3.descending(parseFloat(a.globalsale), parseFloat(b.globalsale)); 
              })
              .transition()
              .ease(d3.easeLinear)
              .duration(aduration)
              .attr('width', (datum) => {return xScale(xBarValue(datum))})
              .attr("y", function(d, i) { //对排序之后的横坐标重排
                  return yScale(tmpPlatforms[i]) + yScale.bandwidth() / 10 ;
              });

              c = c + 1;

            }
        }, aduration); 
        
      })
  </script> 
</body>

</html>
